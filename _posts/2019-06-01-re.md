---
layout:     post
title: 使用正则调整文章格式
subtitle: python-re
date:       2019-06-01
author:     Loopy
header-img: img/home-bg-geek.jpg
catalog: true
tags:
    - Fun

---
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ['\\(','\\)'] ],
      processEscapes: true
    }
  });
  </script>
<script type="text/javascript" async src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

在我逛Github的时候,发现[Sklearn中文文档](https://github.com/apachecn/scikit-learn-doc-zh)的仓库里有大量公式被标记为了python代码段.大概就是:
 - 正常表达:
 ![P(y \mid x_1, \dots, x_n) = \frac{P(y) P(x_1, \dots x_n \mid y)}	![P(y \mid x_1, \dots, x_n) = \frac{P(y) P(x_1, \dots x_n \mid y)}
                                 {P(x_1, \dots, x_n)}](img/32f500a4e2eba65727c1e003699dff90.jpg)	                                 {P(x_1, \dots, x_n)}](img/32f500a4e2eba65727c1e003699dff90.jpg)
 - 实际状况:
 ```py
 ![P(y \mid x_1, \dots, x_n) = \frac{P(y) P(x_1, \dots x_n \mid y)}	![P(y \mid x_1, \dots, x_n) = \frac{P(y) P(x_1, \dots x_n \mid y)}
                                 {P(x_1, \dots, x_n)}](img/32f500a4e2eba65727c1e003699dff90.jpg)	                                 {P(x_1, \dots, x_n)}](img/32f500a4e2eba65727c1e003699dff90.jpg)

 ```
就需要一个脚本把所有的错误标记删掉,大概是这样:
```python
import re
import os


def remove_mark(matched):
    global md_file, flag
    flag = False
    removed_letter = re.sub(r'```\n|```py\n|```|py', "", matched.group())
    removed_letter = re.sub(r'\n+', "\n", removed_letter)
    with open("./docs/log.txt", 'a') as log:
        log.write('=' * 36 + md_file + removed_letter)
    return removed_letter


if __name__ == '__main__':
    for md_file in os.listdir('./docs'):
        if md_file.split('.')[-1] == 'md':
            with open('./docs/'+md_file, 'r+') as f:
                flag = True
                ori_md = f.read()
                fix_md = re.sub('```py\n+!(.|\n)+?```', remove_mark, ori_md)
                if not flag:
                    f.seek(0)
                    f.truncate()
                    f.write(fix_md)
                    print('DONE at', md_file)
                else:
                    print('No jod to do at', md_file)
```
主要包括了:
1. 遍历所有markdown文件:
1. 寻找符合'```py\n+!(.|\n)+?```'patten的错误标记段,若未找到,则不做更改并跳出
1. 把错误标记段用```remove_mark```函数修正(取出标记,整理换行)
1. 将修正好的标记段写到log里,方便人工快速复查
1. 将调整好的文字写回(已置空的)文件里
